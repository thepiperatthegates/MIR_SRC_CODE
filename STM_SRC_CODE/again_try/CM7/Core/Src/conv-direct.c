/*/Users/mac/Documents/GitHub/cmake_mini_rheometer/CM7/Core/Inc/conv-direct.h
 * conv-direct.c
 *
 *  Created on: Feb 17, 2025
 *      Author: hijaz
 */




#include "conv-direct.h"




void ConvDirect_Init(ConvDirect_Container *c, const float *kernel){

	uint32_t i;
	for(i = 0; i<CONVDIRECT_TAPS_LENGTH; i++)
	{
		c->kernelTimerReversed[i] = CONVDIRECT_KERNEL_GAIN * kernel[CONVDIRECT_TAPS_LENGTH - i - 1];
	}

	arm_fir_init_f32(&(c->firProcessor), CONVDIRECT_TAPS_LENGTH, c->kernelTimerReversed, c->firBuf, CONVDIRECT_BUFFER_LENGTH);
}

void ConvDirect_Update(ConvDirect_Container *c, float *inp){


	arm_fir_f32(&(c->firProcessor), inp, c->out, CONVDIRECT_BUFFER_LENGTH);
}


/*

FIR filter designed with
http://t-filter.appspot.com

sampling frequency: 2500 Hz

* 0 Hz - 300 Hz
  gain = 1
  desired ripple = 5 dB
  actual ripple = 3.639061643503998 dB

* 500 Hz - 1250 Hz
  gain = 0
  desired attenuation = -40 dB
  actual attenuation = -158.15030505936681 dB

*/

//ALL BLACKMAN WINDOW, FC around 320

//
//const float32_t filter_taps[CONVDIRECT_TAPS_LENGTH] = {
//
//	    -0.000089789563186740,
//	    -0.000216385694241159,
//	    -0.000374959589151454,
//	    -0.000555159799935935,
//	    -0.000741068608126514,
//	    -0.000911781592114321,
//	    -0.001042655305477721,
//	    -0.001107204310191299,
//	    -0.001079558488120479,
//	    -0.000937320911892157,
//	    -0.000664602617998747,
//	    -0.000254960486072508,
//	    0.000286065438039454,
//	    0.000939123268016705,
//	    0.001670213101875973,
//	    0.002431073452377620,
//	    0.003160939011948650,
//	    0.003789714087750191,
//	    0.004242485801386487,
//	    0.004445174321174622,
//	    0.004330994656437769,
//	    0.003847297115050474,
//	    0.002962272285114486,
//	    0.001670960058923328,
//	    -0.000000000000000002,
//	    -0.001989397913161983,
//	    -0.004200692669556270,
//	    -0.006503760675891054,
//	    -0.008739284525003360,
//	    -0.010725722283454538,
//	    -0.012268596247584838,
//	    -0.013171644321493094,
//	    -0.013249202826438794,
//	    -0.012339051806135318,
//	    -0.010314865738748317,
//	    -0.007097383661664465,
//	    -0.002663448434276562,
//	    0.002947834325017448,
//	    0.009632405864768136,
//	    0.017222408719837389,
//	    0.025491313359918839,
//	    0.034162876285878940,
//	    0.042923520602201067,
//	    0.051437481966333978,
//	    0.059363853792774972,
//	    0.066374512181962747,
//	    0.072171815869706946,
//	    0.076504967207346605,
//	    0.079183988793412458,
//	    0.080090413005324532,
//	    0.079183988793412458,
//	    0.076504967207346605,
//	    0.072171815869706946,
//	    0.066374512181962747,
//	    0.059363853792774972,
//	    0.051437481966334013,
//	    0.042923520602201067,
//	    0.034162876285878940,
//	    0.025491313359918839,
//	    0.017222408719837389,
//	    0.009632405864768136,
//	    0.002947834325017448,
//	    -0.002663448434276562,
//	    -0.007097383661664460,
//	    -0.010314865738748317,
//	    -0.012339051806135318,
//	    -0.013249202826438794,
//	    -0.013171644321493094,
//	    -0.012268596247584838,
//	    -0.010725722283454538,
//	    -0.008739284525003360,
//	    -0.006503760675891054,
//	    -0.004200692669556266,
//	    -0.001989397913161983,
//	    -0.000000000000000002,
//	    0.001670960058923328,
//	    0.002962272285114486,
//	    0.003847297115050474,
//	    0.004330994656437769,
//	    0.004445174321174622,
//	    0.004242485801386487,
//	    0.003789714087750191,
//	    0.003160939011948650,
//	    0.002431073452377620,
//	    0.001670213101875973,
//	    0.000939123268016705,
//	    0.000286065438039454,
//	    -0.000254960486072508,
//	    -0.000664602617998747,
//	    -0.000937320911892157,
//	    -0.001079558488120479,
//	    -0.001107204310191299,
//	    -0.001042655305477719,
//	    -0.000911781592114320,
//	    -0.000741068608126515,
//	    -0.000555159799935935,
//	    -0.000374959589151454,
//	    -0.000216385694241159,
//	    -0.000089789563186740,
//};
//99 taps

//const float32_t filter_taps[CONVDIRECT_TAPS_LENGTH] =
//{
//	0.000000000000000000,
//	    0.000003625989717417,
//	    0.000015880922016028,
//	    0.000037674700837323,
//	    0.000068090317473197,
//	    0.000104054346042388,
//	    0.000140076580911446,
//	    0.000168115542115838,
//	    0.000177639750310856,
//	    0.000155959256828768,
//	    0.000088894934860039,
//	    -0.000038167157650265,
//	    -0.000238822394324559,
//	    -0.000523825814833460,
//	    -0.000898984644502382,
//	    -0.001362901884537074,
//	    -0.001904757560466612,
//	    -0.002502352918533078,
//	    -0.003120664087267998,
//	    -0.003711150312362836,
//	    -0.004212034606159822,
//	    -0.004549720811958547,
//	    -0.004641432778040718,
//	    -0.004399063533733994,
//	    -0.003734112598869636,
//	    -0.002563477362964537,
//	    -0.000815760509255978,
//	    0.001562329477304003,
//	    0.004599963773150923,
//	    0.008297063178863816,
//	    0.012620529136105618,
//	    0.017502247718845475,
//	    0.022839173955038358,
//	    0.028495665965662859,
//	    0.034308077309742828,
//	    0.040091444324105351,
//	    0.045647937430764202,
//	    0.050776595912697620,
//	    0.055283748011645338,
//	    0.058993443493580655,
//	    0.061757201710480644,
//	    0.063462408060033754,
//	    0.064038774352653441,
//	    0.063462408060033754,
//	    0.061757201710480651,
//	    0.058993443493580662,
//	    0.055283748011645359,
//	    0.050776595912697620,
//	    0.045647937430764216,
//	    0.040091444324105364,
//	    0.034308077309742814,
//	    0.028495665965662859,
//	    0.022839173955038355,
//	    0.017502247718845478,
//	    0.012620529136105620,
//	    0.008297063178863815,
//	    0.004599963773150926,
//	    0.001562329477304004,
//	    -0.000815760509255978,
//	    -0.002563477362964538,
//	    -0.003734112598869638,
//	    -0.004399063533733994,
//	    -0.004641432778040722,
//	    -0.004549720811958549,
//	    -0.004212034606159822,
//	    -0.003711150312362840,
//	    -0.003120664087267999,
//	    -0.002502352918533077,
//	    -0.001904757560466610,
//	    -0.001362901884537075,
//	    -0.000898984644502384,
//	    -0.000523825814833459,
//	    -0.000238822394324559,
//	    -0.000038167157650265,
//	    0.000088894934860039,
//	    0.000155959256828768,
//	    0.000177639750310857,
//	    0.000168115542115839,
//	    0.000140076580911446,
//	    0.000104054346042388,
//	    0.000068090317473197,
//	    0.000037674700837324,
//	    0.000015880922016028,
//	    0.000003625989717418,
//	    0.000000000000000000,
//};

//85 taps


//const float32_t filter_taps[CONVDIRECT_TAPS_LENGTH] =
//{
//
//	    0.000000000000000000,
//	    -0.000017087547738821,
//	    -0.000075537422265720,
//	    -0.000182220121499426,
//	    -0.000336569081791690,
//	    -0.000526844688987314,
//	    -0.000725609713572028,
//	    -0.000885189002753683,
//	    -0.000934196875544368,
//	    -0.000776348877695409,
//	    -0.000292675362486190,
//	    0.000652092454357259,
//	    0.002198757147902100,
//	    0.004479010024521360,
//	    0.007598146721166589,
//	    0.011617033914358824,
//	    0.016535655705030627,
//	    0.022280698324061994,
//	    0.028699401099510521,
//	    0.035561312410884845,
//	    0.042568701876943900,
//	    0.049375305895264607,
//	    0.055611970435743688,
//	    0.060916764261023132,
//	    0.064966418090710465,
//	    0.067505616218889813,
//	    0.068370788227929816,
//	    0.067505616218889813,
//	    0.064966418090710465,
//	    0.060916764261023132,
//	    0.055611970435743709,
//	    0.049375305895264614,
//	    0.042568701876943907,
//	    0.035561312410884845,
//	    0.028699401099510531,
//	    0.022280698324062008,
//	    0.016535655705030631,
//	    0.011617033914358827,
//	    0.007598146721166596,
//	    0.004479010024521361,
//	    0.002198757147902099,
//	    0.000652092454357260,
//	    -0.000292675362486190,
//	    -0.000776348877695411,
//	    -0.000934196875544371,
//	    -0.000885189002753683,
//	    -0.000725609713572030,
//	    -0.000526844688987313,
//	    -0.000336569081791689,
//	    -0.000182220121499427,
//	    -0.000075537422265720,
//	    -0.000017087547738821,
//	    0.000000000000000000,
//
//};

//53

//const float32_t filter_taps[CONVDIRECT_TAPS_LENGTH] =
//{
//		   -0.000000000000000001,
//		    0.000398919678708972,
//		    0.002054551993730316,
//		    0.005918733679855640,
//		    0.013155091699373575,
//		    0.024728901791096693,
//		    0.040842603905477386,
//		    0.060467492339167775,
//		    0.081231948871462456,
//		    0.099806331357104650,
//		    0.112720236195534534,
//		    0.117350376976975673,
//		    0.112720236195534548,
//		    0.099806331357104663,
//		    0.081231948871462470,
//		    0.060467492339167823,
//		    0.040842603905477393,
//		    0.024728901791096707,
//		    0.013155091699373588,
//		    0.005918733679855652,
//		    0.002054551993730317,
//		    0.000398919678708971,
//		    -0.000000000000000001,
//};

//23

//const float32_t filter_taps[CONVDIRECT_TAPS_LENGTH] =
//{
//		    -0.000179992017723858,
//		    -0.000094395256759859,
//		    0.000000000000000000,
//		    0.000106385631354747,
//		    0.000227571394887286,
//		    0.000365326578047384,
//		    0.000519739219992363,
//		    0.000688649041382663,
//		    0.000867208765247937,
//		    0.001047623306749269,
//		    0.001219107519412585,
//		    0.001368091201971629,
//		    0.001478685494043362,
//		    0.001533408400792199,
//		    0.001514149905865790,
//		    0.001403339966766571,
//		    0.001185266678931139,
//		    0.000847478058777642,
//		    0.000382190159906200,
//		    -0.000212382614454472,
//		    -0.000930861513473024,
//		    -0.001759785803008383,
//		    -0.002677020141626591,
//		    -0.003651551460096138,
//		    -0.004643723368669505,
//		    -0.005605936045945457,
//		    -0.006483816821982132,
//		    -0.007217842370198709,
//		    -0.007745368806457487,
//		    -0.008003002359896550,
//		    -0.007929221921322590,
//		    -0.007467146906248672,
//		    -0.006567330560649827,
//		    -0.005190450951416474,
//		    -0.003309770025694341,
//		    -0.000913235602805559,
//		    0.001994888031605515,
//		    0.005392958464712847,
//		    0.009241537834521304,
//		    0.013483668730038366,
//		    0.018045862470678360,
//		    0.022839787369259131,
//		    0.027764612702488905,
//		    0.032709933449746167,
//		    0.037559172928268832,
//		    0.042193336653772145,
//		    0.046494972310323492,
//		    0.050352178595124863,
//		    0.053662500586408354,
//		    0.056336551503048740,
//		    0.058301210263099895,
//		    0.059502260726938920,
//		    0.059906361208530587,
//		    0.059502260726938920,
//		    0.058301210263099895,
//		    0.056336551503048747,
//		    0.053662500586408354,
//		    0.050352178595124863,
//		    0.046494972310323492,
//		    0.042193336653772145,
//		    0.037559172928268839,
//		    0.032709933449746167,
//		    0.027764612702488908,
//		    0.022839787369259131,
//		    0.018045862470678360,
//		    0.013483668730038369,
//		    0.009241537834521306,
//		    0.005392958464712847,
//		    0.001994888031605515,
//		    -0.000913235602805560,
//		    -0.003309770025694342,
//		    -0.005190450951416474,
//		    -0.006567330560649830,
//		    -0.007467146906248676,
//		    -0.007929221921322591,
//		    -0.008003002359896552,
//		    -0.007745368806457489,
//		    -0.007217842370198709,
//		    -0.006483816821982132,
//		    -0.005605936045945455,
//		    -0.004643723368669504,
//		    -0.003651551460096139,
//		    -0.002677020141626593,
//		    -0.001759785803008383,
//		    -0.000930861513473024,
//		    -0.000212382614454472,
//		    0.000382190159906200,
//		    0.000847478058777643,
//		    0.001185266678931141,
//		    0.001403339966766571,
//		    0.001514149905865790,
//		    0.001533408400792199,
//		    0.001478685494043363,
//		    0.001368091201971630,
//		    0.001219107519412585,
//		    0.001047623306749270,
//		    0.000867208765247937,
//		    0.000688649041382663,
//		    0.000519739219992363,
//		    0.000365326578047383,
//		    0.000227571394887286,
//		    0.000106385631354747,
//		    0.000000000000000000,
//		    -0.000094395256759859,
//		    -0.000179992017723858,
//
//};
//105 taps





// kaiser windows
//fc = 400 hz
//const float32_t filter_taps[CONVDIRECT_TAPS_LENGTH] =
//{

//		   0.001165328182673307,
//		    0.001031287735290948,
//		    0.000655663569944012,
//		    -0.000000000000000001,
//		    -0.000950095306604157,
//		    -0.002177569262974258,
//		    -0.003628481436807316,
//		    -0.005209341703864880,
//		    -0.006787881181182264,
//		    -0.008197638671663421,
//		    -0.009246408796027327,
//		    -0.009728226777363900,
//		    -0.009438193581049154,
//		    -0.008189111200058791,
//		    -0.005828637222971634,
//		    -0.002255511031772952,
//		    0.002566627089007662,
//		    0.008599197536639114,
//		    0.015723558519900531,
//		    0.023741577028394710,
//		    0.032382225639863753,
//		    0.041314039071547397,
//		    0.050162758866662521,
//		    0.058533028276245881,
//		    0.066032616550507586,
//		    0.072297390070775486,
//		    0.077015134053561723,
//		    0.079946376555455695,
//		    0.080940574851739389,
//		    0.079946376555455695,
//		    0.077015134053561723,
//		    0.072297390070775472,
//		    0.066032616550507586,
//		    0.058533028276245881,
//		    0.050162758866662521,
//		    0.041314039071547397,
//		    0.032382225639863753,
//		    0.023741577028394710,
//		    0.015723558519900531,
//		    0.008599197536639114,
//		    0.002566627089007662,
//		    -0.002255511031772953,
//		    -0.005828637222971634,
//		    -0.008189111200058791,
//		    -0.009438193581049154,
//		    -0.009728226777363900,
//		    -0.009246408796027327,
//		    -0.008197638671663421,
//		    -0.006787881181182264,
//		    -0.005209341703864880,
//		    -0.003628481436807315,
//		    -0.002177569262974258,
//		    -0.000950095306604157,
//		    -0.000000000000000001,
//		    0.000655663569944012,
//		    0.001031287735290949,
//		    0.001165328182673307,



//};
//57 taps

// start of experiment

//
//
//const float32_t filter_taps[CONVDIRECT_TAPS_LENGTH] =
//{
//
//		 0.009082479966205859,
//		    0.015952216480505963,
//		    0.023234853965074423,
//		    0.030695728078538806,
//		    0.038084022811660879,
//		    0.045143296703246204,
//		    0.051622456922709739,
//		    0.057286661223692671,
//		    0.061927626244948367,
//		    0.065372845521188064,
//		    0.067493270732698937,
//		    0.068209082699060161,
//		    0.067493270732698937,
//		    0.065372845521188064,
//		    0.061927626244948367,
//		    0.057286661223692671,
//		    0.051622456922709739,
//		    0.045143296703246204,
//		    0.038084022811660879,
//		    0.030695728078538806,
//		    0.023234853965074423,
//		    0.015952216480505963,
//		    0.009082479966205859,
//
//};
//rect window function
//fc = 400
//bandbreite = 400
//23 taps

const float32_t filter_taps[CONVDIRECT_TAPS_LENGTH] =
{

		  -0.000240006311143167,
		    -0.000085427597769684,
		    0.000092543870091168,
		    0.000303449962388875,
		    0.000553375332648108,
		    0.000841359666770234,
		    0.001156360039574071,
		    0.001475295081128785,
		    0.001762617847741638,
		    0.001971719942107280,
		    0.002048277978396039,
		    0.001935433107370774,
		    0.001580467216982965,
		    0.000942429709958810,
		    -0.000000000000000001,
		    -0.001241236366251323,
		    -0.002742950432681208,
		    -0.004430469098193381,
		    -0.006192068569360537,
		    -0.007881602752321417,
		    -0.009324630085085949,
		    -0.010327887976305563,
		    -0.010691640633035465,
		    -0.010224123890809183,
		    -0.008757059351029330,
		    -0.006161035841466099,
		    -0.002359478992300647,
		    0.002660038615400380,
		    0.008838251509671550,
		    0.016041278429789928,
		    0.024062849773867086,
		    0.032631821515725482,
		    0.041424692984270317,
		    0.050082435088493443,
		    0.058230568368736052,
		    0.065501139326758662,
		    0.071555055470411050,
		    0.076103172510712705,
		    0.078924588998195114,
		    0.079880791101125073,
		    0.078924588998195114,
		    0.076103172510712719,
		    0.071555055470411050,
		    0.065501139326758676,
		    0.058230568368736052,
		    0.050082435088493443,
		    0.041424692984270338,
		    0.032631821515725488,
		    0.024062849773867096,
		    0.016041278429789928,
		    0.008838251509671550,
		    0.002660038615400380,
		    -0.002359478992300646,
		    -0.006161035841466099,
		    -0.008757059351029333,
		    -0.010224123890809183,
		    -0.010691640633035467,
		    -0.010327887976305565,
		    -0.009324630085085949,
		    -0.007881602752321420,
		    -0.006192068569360541,
		    -0.004430469098193382,
		    -0.002742950432681210,
		    -0.001241236366251324,
		    -0.000000000000000001,
		    0.000942429709958811,
		    0.001580467216982966,
		    0.001935433107370776,
		    0.002048277978396040,
		    0.001971719942107282,
		    0.001762617847741638,
		    0.001475295081128786,
		    0.001156360039574071,
		    0.000841359666770235,
		    0.000553375332648107,
		    0.000303449962388875,
		    0.000092543870091168,
		    -0.000085427597769684,
		    -0.000240006311143167,

};
//hamming window function
//fc = 400
//bandbreite = 400
//79 taps
//
//const float32_t filter_taps[CONVDIRECT_TAPS_LENGTH] =
//{
//
//		  0.000000000000000000,
//		    0.000001552665952967,
//		    0.000006045727296273,
//		    0.000012366638548954,
//		    0.000018297013077202,
//		    0.000020700775014367,
//		    0.000015867395468571,
//		    0.000000000000000000,
//		    -0.000030177174878552,
//		    -0.000076735051493877,
//		    -0.000139841149021983,
//		    -0.000217124592171444,
//		    -0.000303195821198544,
//		    -0.000389417531496686,
//		    -0.000464018521207209,
//		    -0.000512624809713191,
//		    -0.000519251596391317,
//		    -0.000467755971384620,
//		    -0.000343696263343877,
//		    -0.000136483918842088,
//		    0.000158346061193159,
//		    0.000536972586883317,
//		    0.000985497693468217,
//		    0.001478806385878138,
//		    0.001980342848093270,
//		    0.002443023947784113,
//		    0.002811434151293915,
//		    0.003025340381994955,
//		    0.003024437963642631,
//		    0.002754099946757410,
//		    0.002171764834224101,
//		    0.001253476542520441,
//		    -0.000000000000000001,
//		    -0.001558110743014210,
//		    -0.003357107525544638,
//		    -0.005298854662707245,
//		    -0.007252268502499601,
//		    -0.009057630225811693,
//		    -0.010533788750162512,
//		    -0.011488021926153568,
//		    -0.011728071285916561,
//		    -0.011075631584850854,
//		    -0.009380384464327780,
//		    -0.006533536678891387,
//		    -0.002479773931077831,
//		    0.002773418459636669,
//		    0.009149984667050198,
//		    0.016503775695725184,
//		    0.024621683424218704,
//		    0.033231499537008484,
//		    0.042014203961521224,
//		    0.050620030909565392,
//		    0.058687342031452955,
//		    0.065863084107221789,
//		    0.071823446692263024,
//		    0.076293279453756066,
//		    0.079062886843253244,
//		    0.080000986680672570,
//		    0.079062886843253258,
//		    0.076293279453756066,
//		    0.071823446692263024,
//		    0.065863084107221789,
//		    0.058687342031452948,
//		    0.050620030909565399,
//		    0.042014203961521224,
//		    0.033231499537008491,
//		    0.024621683424218714,
//		    0.016503775695725184,
//		    0.009149984667050200,
//		    0.002773418459636669,
//		    -0.002479773931077831,
//		    -0.006533536678891389,
//		    -0.009380384464327780,
//		    -0.011075631584850858,
//		    -0.011728071285916564,
//		    -0.011488021926153575,
//		    -0.010533788750162518,
//		    -0.009057630225811693,
//		    -0.007252268502499605,
//		    -0.005298854662707247,
//		    -0.003357107525544640,
//		    -0.001558110743014210,
//		    -0.000000000000000001,
//		    0.001253476542520441,
//		    0.002171764834224101,
//		    0.002754099946757410,
//		    0.003024437963642633,
//		    0.003025340381994960,
//		    0.002811434151293916,
//		    0.002443023947784113,
//		    0.001980342848093272,
//		    0.001478806385878138,
//		    0.000985497693468218,
//		    0.000536972586883318,
//		    0.000158346061193159,
//		    -0.000136483918842088,
//		    -0.000343696263343877,
//		    -0.000467755971384621,
//		    -0.000519251596391317,
//		    -0.000512624809713191,
//		    -0.000464018521207209,
//		    -0.000389417531496685,
//		    -0.000303195821198544,
//		    -0.000217124592171445,
//		    -0.000139841149021982,
//		    -0.000076735051493877,
//		    -0.000030177174878553,
//		    0.000000000000000000,
//		    0.000015867395468571,
//		    0.000020700775014367,
//		    0.000018297013077202,
//		    0.000012366638548954,
//		    0.000006045727296273,
//		    0.000001552665952967,
//		    0.000000000000000000,
//};
//blackman window function
//fc = 400
//bandbreite = 400
//115 taps






